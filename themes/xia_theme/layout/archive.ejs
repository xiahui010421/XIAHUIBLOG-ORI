<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>归档 - <%= theme.site_title %></title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    /* 整体布局 */
    .archive-page {
      width: 90%;
      max-width: 1620px;
      margin: 0 auto;
      padding: 0;
    }

    .archive-main {
      display: flex;
      gap: 32px;
      width: 100%;
      margin: 0 auto;
      margin-top: 30px;
      padding: 60px 0 100px;
      box-sizing: border-box;
      min-height: 80vh;
    }

    /* 左侧二级菜单 */
    .archive-sidebar {
      width: 220px; /* 增大侧边栏宽度 */
      flex-shrink: 0;
      background: #f7fafd;
      border-radius: 8px;
      border: 1px solid #e1e8f0;
      padding: 0;
      position: sticky;
      top: 80px;
      height: fit-content;
    }

    .archive-category-group,
    .archive-tag-group {
      border-bottom: 1px solid #e1e8f0;
    }

    .archive-group-title {
      padding: 16px 24px;
      margin: 0;
      font-size: 1.1em;
      color: #2d3748;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .archive-group-title:hover {
      background: #e7f2fa;
    }

    .archive-group-title::after {
      content: '▾';
      font-size: 0.8em;
      transition: transform 0.2s;
    }

    .archive-group.open .archive-group-title::after {
      transform: rotate(180deg);
    }

    .archive-submenu {
      display: none;
      padding: 8px 0;
    }

    .archive-group.open .archive-submenu {
      display: block;
    }

    .archive-submenu-item {
      padding: 10px 24px 10px 36px;
      font-size: 0.95em;
      color: #5296d5;
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    .archive-submenu-item:hover,
    .archive-submenu-item.active {
      background: #e7f2fa;
      color: #2167b8;
      font-weight: 500;
    }

    .archive-submenu-count {
      margin-left: auto;
      font-size: 0.85em;
      color: #999;
    }

    /* 右侧文章列表 */
    .archive-content {
      flex: 1;
      min-width: 0;
    }

    .archive-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%;
    }

    .post-card {
      display: flex;
      flex-direction: row;
      gap: 16px;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #f0f4f8;
      box-shadow: 0 1px 1px rgba(0,0,0,0.02);
      transition: all 0.15s;
      width: 100%;
      box-sizing: border-box;
    }

    .post-thumbnail {
      width: 100px;
      height: 100px;
      flex-shrink: 0;
      border-radius: 4px;
      overflow: hidden;
      background: #f0f4f8;
    }

    .post-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .post-info {
      flex: 1;
      min-width: 0;
    }

    .post-title {
      margin: 0 0 4px 0;
      font-size: 1.05em;
      line-height: 1.3;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .post-meta {
      color: #718096;
      font-size: 0.85em;
      margin-bottom: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .post-excerpt {
      color: #4a5568;
      font-size: 0.9em;
      line-height: 1.5;
      margin: 0;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* 空状态样式 */
    .archive-empty {
      text-align: center;
      padding: 40px 0;
      color: #999;
      font-size: 0.95em;
    }

    /* 响应式设计 */
    @media (min-width: 1200px) {
      .archive-sidebar {
        width: 240px;
      }
      .post-thumbnail {
        width: 120px;
        height: 120px;
      }
      .post-title {
        font-size: 1.15em;
      }
      .post-excerpt {
        -webkit-line-clamp: 3;
      }
    }

    @media (max-width: 900px) {
      .archive-main {
        flex-direction: column;
        gap: 20px;
        padding: 40px 0 80px;
      }
      .archive-sidebar {
        width: 100%;
        position: static;
      }
      .archive-group-title {
        padding: 12px 16px;
      }
      .archive-submenu-item {
        padding: 8px 16px 8px 28px;
      }
      .post-card {
        flex-direction: column;
      }
      .post-thumbnail {
        width: 100%;
        height: 180px;
      }
    }
  </style>
</head>
<body>
  <%- partial('_partial/header') %>
  <div class="archive-page">
    <main class="archive-main">
      <aside class="archive-sidebar">
        <div class="archive-category-group archive-group open">
          <h3 class="archive-group-title">分类</h3>
          <div class="archive-submenu" id="category-submenu">
            <!-- 分类项将通过JS动态生成 -->
          </div>
        </div>
        
        <div class="archive-tag-group archive-group open">
          <h3 class="archive-group-title">标签</h3>
          <div class="archive-submenu" id="tag-submenu">
            <!-- 标签项将通过JS动态生成 -->
          </div>
        </div>
      </aside>

      <section class="archive-content">
        <div id="archive-list" class="archive-list">
          <% site.posts.sort('-date').forEach(function(post) { %>
            <article class="card post-card"
              data-category="<%= (post.categories && post.categories.length) ? post.categories.map(c => c.name).join(',') : '' %>"
              data-tag="<%= (post.tags && post.tags.length) ? post.tags.map(t => t.name).join(',') : '' %>">
              <div class="post-thumbnail">
                <% if(post.thumbnail) { %>
                  <img src="<%= post.thumbnail %>" alt="<%= post.title %>" />
                <% } else { %>
                  <div style="width: 100%; height: 100%; background: #f0f4f8;"></div>
                <% } %>
              </div>
              <div class="post-info">
                <h2 class="post-title">
                  <a href="<%= url_for(post.path) %>"><%= post.title %></a>
                </h2>
                <div class="post-meta">
                  <time datetime="<%= post.date.toISOString() %>"><%= date(post.date, 'YYYY-MM-DD') %></time>
                  <% if(post.categories && post.categories.length) { %>
                    <span class="post-categories">
                      <% post.categories.forEach(function(cat, idx) { %>
                        <a href="<%= url_for(cat.path) %>"><%= cat.name %></a><%= idx < post.categories.length - 1 ? ', ' : '' %>
                      <% }); %>
                    </span>
                  <% } %>
                  <% if(post.tags && post.tags.length) { %>
                    <span class="post-tags">
                      <% post.tags.forEach(function(tag, idx) { %>
                        <a href="<%= url_for(tag.path) %>"><%= tag.name %></a><%= idx < post.tags.length - 1 ? ', ' : '' %>
                      <% }); %>
                    </span>
                  <% } %>
                </div>
                <% if(post.excerpt) { %>
                  <p class="post-excerpt"><%= post.excerpt %></p>
                <% } %>
              </div>
            </article>
          <% }); %>
        </div>
      </section>
    </main>
  </div>
  <%- partial('_partial/footer') %>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const posts = Array.from(document.querySelectorAll('.post-card'));
      
      // 提取分类和标签并统计数量
      const categoryCount = new Map();
      const tagCount = new Map();
      
      posts.forEach(post => {
        if (post.dataset.category) {
          post.dataset.category.split(',').forEach(cat => {
            categoryCount.set(cat, (categoryCount.get(cat) || 0) + 1);
          });
        }
        if (post.dataset.tag) {
          post.dataset.tag.split(',').forEach(tag => {
            tagCount.set(tag, (tagCount.get(tag) || 0) + 1);
          });
        }
      });

      // 填充分类和标签菜单
      function fillMenu(menuId, items, type) {
        const menu = document.getElementById(menuId);
        if (!menu) return;
        
        menu.innerHTML = '';
        items.forEach(item => {
          const count = type === 'category' ? categoryCount.get(item) : tagCount.get(item);
          const itemEl = document.createElement('div');
          itemEl.className = 'archive-submenu-item';
          itemEl.innerHTML = `
            <span>${item}</span>
            <span class="archive-submenu-count">${count || 0}</span>
          `;
          itemEl.dataset.value = item;
          itemEl.onclick = function() {
            document.querySelectorAll('.archive-submenu-item').forEach(el => {
              el.classList.remove('active');
            });
            this.classList.add('active');
            filterPosts(type, item);
          };
          menu.appendChild(itemEl);
        });
      }
      
      fillMenu('category-submenu', Array.from(categoryCount.keys()).filter(Boolean), 'category');
      fillMenu('tag-submenu', Array.from(tagCount.keys()).filter(Boolean), 'tag');

      // 二级菜单折叠/展开功能
      document.querySelectorAll('.archive-group-title').forEach(title => {
        title.onclick = function() {
          const group = this.parentElement;
          group.classList.toggle('open');
        };
      });

      // 筛选功能
      function filterPosts(type, value) {
        posts.forEach(post => {
          let shouldShow = false;
          if (type === 'category') {
            shouldShow = post.dataset.category.split(',').includes(value);
          } else if (type === 'tag') {
            shouldShow = post.dataset.tag.split(',').includes(value);
          }
          post.style.display = shouldShow ? 'flex' : 'none';
          if (window.innerWidth <= 900 && shouldShow) {
            post.style.display = 'block';
          }
        });
      }
    });
  </script>
</body>
</html>