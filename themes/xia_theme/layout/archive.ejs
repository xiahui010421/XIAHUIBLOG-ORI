<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>归档 - <%= theme.site_title %></title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/archive.css">
</head>
<body>
  <%- partial('_partial/header') %>
  <div class="archive-page">
    <main class="archive-main">
      <aside class="archive-sidebar">
        <div class="show-all-item active" id="show-all">
          显示全部文章
        </div>
        
        <div class="archive-category-group archive-group open">
          <h3 class="archive-group-title">分类</h3>
          <div class="archive-submenu" id="category-submenu">
            <!-- 分类项将通过JS动态生成 -->
          </div>
        </div>
        
        <div class="archive-tag-group archive-group open">
          <h3 class="archive-group-title">标签</h3>
          <div class="archive-submenu" id="tag-submenu">
            <!-- 标签项将通过JS动态生成 -->
          </div>
        </div>
      </aside>
      <section class="archive-content">
        <div class="current-filter" id="current-filter"></div>
        <div id="archive-list" class="archive-list">
          <% site.posts.sort('-date').forEach(function(post) { %>
            <% 
            // 尝试多种方式获取图片路径
            var imageUrl = '';
            if (post.thumbnail) {
              imageUrl = post.thumbnail;
            } else if (post.cover) {
              imageUrl = post.cover;
            } else if (post.image) {
              imageUrl = post.image;
            } else if (post.banner) {
              imageUrl = post.banner;
            }
            
            // 检查文章内容中是否有图片
            if (!imageUrl && post.content) {
              var imgMatch = post.content.match(/!\[.*?\]\((.*?)\)/);
              if (imgMatch && imgMatch[1]) {
                imageUrl = imgMatch[1];
              } else {
                imgMatch = post.content.match(/<img[^>]+src=["']([^"']+)["']/i);
                if (imgMatch && imgMatch[1]) {
                  imageUrl = imgMatch[1];
                }
              }
            }
            %>
            <article class="card post-card"
              data-category="<%= (post.categories && post.categories.length) ? post.categories.map(c => c.name).join(',') : '' %>"
              data-tag="<%= (post.tags && post.tags.length) ? post.tags.map(t => t.name).join(',') : '' %>">
              <div class="post-thumbnail">
                <% if(imageUrl && imageUrl.trim() !== '') { %>
                  <!-- 有图片，设置原始路径 -->
                  <img src="<%= imageUrl %>" alt="<%= post.title %>" 
                       data-has-thumbnail="true" 
                       data-original-src="<%= imageUrl %>" />
                <% } else { %>
                  <!-- 没有图片，使用随机图片 -->
                  <img src="" alt="<%= post.title %>" 
                       class="random-image" 
                       data-has-thumbnail="false" />
                <% } %>
              </div>
              <div class="post-info">
                <h2 class="post-title">
                  <a href="<%= url_for(post.path) %>"><%= post.title %></a>
                </h2>
                <div class="post-meta">
                  <time datetime="<%= post.date.toISOString() %>"><%= date(post.date, 'YYYY-MM-DD') %></time>
                  <% if(post.categories && post.categories.length) { %>
                    <span class="post-categories">
                      <% post.categories.forEach(function(cat, idx) { %>
                        <a href="<%= url_for(cat.path) %>"><%= cat.name %></a><%= idx < post.categories.length - 1 ? ', ' : '' %>
                      <% }); %>
                    </span>
                  <% } %>
                  <% if(post.tags && post.tags.length) { %>
                    <span class="post-tags">
                      <% post.tags.forEach(function(tag, idx) { %>
                        <a href="<%= url_for(tag.path) %>"><%= tag.name %></a><%= idx < post.tags.length - 1 ? ', ' : '' %>
                      <% }); %>
                    </span>
                  <% } %>
                </div>
                <% if(post.excerpt) { %>
                  <p class="post-excerpt"><%= post.excerpt %></p>
                <% } %>
              </div>
            </article>
          <% }); %>
        </div>
      </section>
    </main>
  </div>
  <%- partial('_partial/footer') %>
  <script src="/js/archive.js"></script>
</body>
</html>